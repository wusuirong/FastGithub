name: Create Release  
  
on:  
  workflow_dispatch:  
    inputs:  
      version:  
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)'  
        required: true  
        type: string  
      prerelease:  
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'  
        required: false  
        type: boolean  
        default: false  
  
jobs:  
  build-and-release:  
    runs-on: ubuntu-latest  
      
    steps:  
    - name: Checkout code  
      uses: actions/checkout@v4  
      with:  
        fetch-depth: 0  
  
    - name: Setup .NET  
      uses: actions/setup-dotnet@v4  
      with:  
        dotnet-version: '7.0.x'  
  
    - name: Validate version format  
      run: |  
        if [[ ! "${{ github.event.inputs.version }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then  
          echo "é”™è¯¯: ç‰ˆæœ¬å·æ ¼å¼ä¸æ­£ç¡®ã€‚è¯·ä½¿ç”¨æ ¼å¼: v1.0.0 æˆ– v1.0.0-beta"  
          exit 1  
        fi  
  
    - name: Check if tag exists  
      run: |  
        if git rev-parse "${{ github.event.inputs.version }}" >/dev/null 2>&1; then  
          echo "é”™è¯¯: æ ‡ç­¾ ${{ github.event.inputs.version }} å·²å­˜åœ¨"  
          exit 1  
        fi  
  
    - name: Create and push tag  
      run: |  
        git config user.name "github-actions[bot]"  
        git config user.email "github-actions[bot]@users.noreply.github.com"  
        git tag -a "${{ github.event.inputs.version }}" -m "Release ${{ github.event.inputs.version }}"  
        git push origin "${{ github.event.inputs.version }}"  
      env:  
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  
  
  build-artifacts:  
    needs: build-and-release  
    runs-on: ${{ matrix.os }}  
    strategy:  
      matrix:  
        os: [ubuntu-latest, windows-latest, macos-latest]  
        include:  
          - os: ubuntu-latest  
            runtime: linux-x64  
            artifact-name: fastgithub-linux-x64  
          - os: windows-latest  
            runtime: win-x64  
            artifact-name: fastgithub-win-x64  
          - os: macos-latest  
            runtime: osx-x64  
            artifact-name: fastgithub-osx-x64  
  
    steps:  
    - name: Checkout code  
      uses: actions/checkout@v4  
      with:  
        ref: ${{ github.event.inputs.version }}  
  
    - name: Setup .NET  
      uses: actions/setup-dotnet@v4  
      with:  
        dotnet-version: '7.0.x'  
  
    - name: Restore dependencies  
      run: dotnet restore FastGithub.sln
  
    - name: Build and publish
      shell: bash
      run: |
        # å‘å¸ƒä¸»ç¨‹åº
        dotnet publish FastGithub/FastGithub.csproj \
          -c Release \
          -r ${{ matrix.runtime }} \
          --self-contained true \
          -p:PublishSingleFile=true \
          -p:PublishTrimmed=true \
          -o ./publish/${{ matrix.runtime }}
  
        # å‘å¸ƒ UI (ä»… Windows)
        if [ "${{ matrix.runtime }}" == "win-x64" ]; then
          dotnet publish FastGithub.UI/FastGithub.UI.csproj \
            -c Release \
            -o ./publish/${{ matrix.runtime }}
        fi

    - name: Create archive  
      shell: bash  
      run: |  
        cd ./publish/${{ matrix.runtime }}  
        if [ "${{ matrix.os }}" == "windows-latest" ]; then  
          7z a -tzip ../../${{ matrix.artifact-name }}.zip *  
        else  
          tar -czf ../../${{ matrix.artifact-name }}.tar.gz *  
        fi  
  
    - name: Upload artifacts  
      uses: actions/upload-artifact@v4  
      with:  
        name: ${{ matrix.artifact-name }}  
        path: |  
          ${{ matrix.artifact-name }}.zip  
          ${{ matrix.artifact-name }}.tar.gz  
  
  create-github-release:  
    needs: build-artifacts  
    runs-on: ubuntu-latest  
      
    steps:  
    - name: Checkout code  
      uses: actions/checkout@v4  
      with:  
        ref: ${{ github.event.inputs.version }}  
  
    - name: Download all artifacts  
      uses: actions/download-artifact@v4  
      with:  
        path: ./artifacts  
  
    - name: Prepare release assets  
      run: |  
        mkdir -p ./release-assets  
        find ./artifacts -name "*.zip" -o -name "*.tar.gz" | while read file; do  
          cp "$file" ./release-assets/  
        done  
        ls -la ./release-assets/  
  
    - name: Generate release notes  
      id: release_notes  
      run: |  
        cat > release_notes.md << 'EOF'  
        ## FastGithub Release ${{ github.event.inputs.version }}  
          
        ðŸš€ **æ–°ç‰ˆæœ¬å‘å¸ƒ**  
          
        ### ðŸ“¦ ä¸‹è½½è¯´æ˜Ž  
        - **Windows ç”¨æˆ·**: ä¸‹è½½ `fastgithub-win-x64.zip`  
        - **Linux ç”¨æˆ·**: ä¸‹è½½ `fastgithub-linux-x64.tar.gz`  
        - **macOS ç”¨æˆ·**: ä¸‹è½½ `fastgithub-osx-x64.tar.gz`  
          
        ### ðŸ”§ å®‰è£…è¯´æ˜Ž  
        è¯·å‚è€ƒ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md) ä¸­çš„éƒ¨ç½²æ–¹å¼ã€‚  
          
        ### âš ï¸ æ³¨æ„äº‹é¡¹  
        - Windowsç‰ˆæœ¬åŒ…å«UIç•Œé¢ç¨‹åº  
        - é¦–æ¬¡ä½¿ç”¨éœ€è¦å®‰è£…å¹¶ä¿¡ä»»CAè¯ä¹¦  
        - è¯¦ç»†é…ç½®è¯·æŸ¥çœ‹é¡¹ç›®æ–‡æ¡£  
          
        ---  
          
        **å®Œæ•´æ›´æ–°æ—¥å¿—**: https://github.com/${{ github.repository }}/compare/$(git describe --tags --abbrev=0 HEAD^)...${{ github.event.inputs.version }}  
        EOF  
  
    - name: Create GitHub Release  
      uses: softprops/action-gh-release@v1  
      with:  
        tag_name: ${{ github.event.inputs.version }}  
        name: FastGithub ${{ github.event.inputs.version }}  
        body_path: release_notes.md  
        files: ./release-assets/*  
        draft: false  
        prerelease: ${{ github.event.inputs.prerelease }}  
        generate_release_notes: true  
      env:  
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  
  
    - name: Cleanup artifacts  
      run: rm -rf ./artifacts ./release-assets release_notes.md
